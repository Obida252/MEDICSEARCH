<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDICSEARCH • Administration de la base de données</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .admin-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .stat-card h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--black);
        }
        
        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }
        
        .action-buttons .btn-primary {
            padding: 12px 24px;
            font-weight: 700;
        }
        
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-loading:after {
            content: "...";
            animation: loading-dots 1.5s infinite;
        }
        
        @keyframes loading-dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        
        .recent-updates {
            margin-top: 30px;
        }
        
        .update-item {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .update-item:last-child {
            border-bottom: none;
        }
        
        .update-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .update-date {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }
        
        .scraping-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-pill {
            background-color: var(--light-gray);
            border-radius: 30px;
            padding: 8px 15px;
            text-align: center;
        }
        
        .stat-pill .number {
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Progress bar styles */
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            height: 30px;
            border-radius: 4px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 30px;
            color: white;
            transition: width 0.5s;
        }
        
        .scraping-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .btn-stop {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .scraping-status {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Styles pour la console de logs */
        .log-console {
            background-color: #282c34;
            color: #abb2bf;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-console .log-line {
            margin: 3px 0;
            line-height: 1.4;
        }
        
        .log-console .log-info {
            color: #98c379;
        }
        
        .log-console .log-warning {
            color: #d19a66;
        }
        
        .log-console .log-error {
            color: #e06c75;
        }
        
        .log-console-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .log-console-toolbar {
            margin-top: 10px;
        }
        
        .log-console-toolbar button {
            background-color: #4b5363;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.8rem;
        }
        
        .log-console-toolbar button:hover {
            background-color: #5c6370;
        }
        
        .log-toggle {
            text-align: center;
            margin: 15px 0;
        }
        
        .btn-secondary {
            background-color: #5c6bc0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-block;
        }
        
        .btn-secondary:hover {
            background-color: #3949ab;
        }
        
        .btn-secondary:disabled {
            background-color: #9fa8da;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    {% with active_page='admin' %}
    {% include 'components/header.html' %}
    {% endwith %}

    <main>
        <section class="auth-section">
            <div class="container">
                <div class="auth-container" style="max-width: 1000px;">
                    <h2>ADMINISTRATION DE LA BASE DE DONNÉES</h2>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <div class="admin-dashboard">
                        <div class="stat-card">
                            <h3>MÉDICAMENTS</h3>
                            <div class="stat-number">{{ total_medicines }}</div>
                            <p>médicaments dans la base de données</p>
                        </div>
                        
                        <div class="stat-card">
                            <h3>LABORATOIRES</h3>
                            <div class="stat-number">{{ lab_count }}</div>
                            <p>laboratoires pharmaceutiques</p>
                        </div>
                        
                        <div class="stat-card">
                            <h3>SUBSTANCES</h3>
                            <div class="stat-number">{{ substance_count }}</div>
                            <p>substances actives uniques</p>
                        </div>
                        
                        <div class="stat-card">
                            <h3>DERNIER SCRAPING</h3>
                            {% if metadata and metadata.last_update %}
                                <div class="stat-date">{{ metadata.last_update.strftime('%d/%m/%Y à %H:%M') }}</div>
                                <p>Il y a {{ ((now - metadata.last_update).total_seconds() / 86400)|round|int }} jours</p>
                            {% else %}
                                <div class="stat-date">Jamais exécuté</div>
                                <p>Aucune donnée de scraping disponible</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if metadata and metadata.last_scraping_results %}
                    <div class="stat-card">
                        <h3>RÉSULTATS DU DERNIER SCRAPING</h3>
                        <div class="scraping-stats">
                            <div class="stat-pill">
                                <div class="number">{{ metadata.last_scraping_results.total_processed }}</div>
                                <div class="label">URLs traitées</div>
                            </div>
                            <div class="stat-pill">
                                <div class="number">{{ metadata.last_scraping_results.new_added }}</div>
                                <div class="label">Nouveaux</div>
                            </div>
                            <div class="stat-pill">
                                <div class="number">{{ metadata.last_scraping_results.updated }}</div>
                                <div class="label">Mis à jour</div>
                            </div>
                            <div class="stat-pill">
                                <div class="number">{{ metadata.last_scraping_results.unchanged }}</div>
                                <div class="label">Inchangés</div>
                            </div>
                            <div class="stat-pill">
                                <div class="number">{{ metadata.last_scraping_results.errors }}</div>
                                <div class="label">Erreurs</div>
                            </div>
                            {% if metadata.last_scraping_results.duration %}
                            <div class="stat-pill">
                                <div class="number">{{ (metadata.last_scraping_results.duration / 60)|round|int }}min</div>
                                <div class="label">Durée</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="action-buttons">
                        <form action="{{ url_for('users.admin_run_scraper') }}" method="POST" id="scraper-form">
                            <button type="submit" class="btn-primary" id="run-scraper-btn">
                                <i class="fas fa-sync-alt"></i> LANCER LE SCRAPING COMPLET
                            </button>
                        </form>
                        
                        <p class="text-muted" style="margin-top: 10px;">
                            <small>Cette opération effectue un scraping complet et peut prendre plusieurs minutes. Vous pouvez quitter et revenir sur cette page.</small>
                        </p>
                        
                        <!-- Progress bar container -->
                        <div class="progress-container" id="progress-container">
                            <div class="progress-bar" id="progress-bar">0%</div>
                            
                            <div class="scraping-controls">
                                <button class="btn-stop" id="stop-scraper-btn">
                                    <i class="fas fa-stop"></i> Arrêter le scraping
                                </button>
                            </div>
                            
                            <div class="scraping-status" id="scraping-status">
                                Traitement en cours...
                            </div>
                        </div>
                        
                        <!-- Console de logs -->
                        <div class="log-toggle">
                            <button class="btn-primary" id="toggle-console-btn">
                                <i class="fas fa-terminal"></i> Afficher la console de logs
                            </button>
                        </div>
                        
                        <div class="log-console" id="log-console">
                            <div class="log-console-header">
                                <strong>Console de logs</strong>
                                <span>Scraping en temps réel</span>
                            </div>
                            <div id="log-content"></div>
                            <div class="log-console-toolbar">
                                <button id="clear-logs-btn">Effacer</button>
                                <button id="autoscroll-btn" data-enabled="true">Auto-scroll: ON</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card recent-updates">
                        <h3>MISES À JOUR RÉCENTES</h3>
                        {% if latest_updates %}
                            {% for med in latest_updates %}
                            <div class="update-item">
                                <div class="update-title">{{ med.title }}</div>
                                <div class="update-date">
                                    <i class="fas fa-calendar-alt"></i> Mise à jour ANSM: {{ med.update_date }}
                                    {% if med.last_scraped %}
                                    <br>
                                    <i class="fas fa-sync"></i> Dernière analyse: {{ med.last_scraped.strftime('%d/%m/%Y à %H:%M') }}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>Aucune mise à jour récente</p>
                        {% endif %}
                    </div>
                    
                </div>
            </div>
        </section>
    </main>

    {% with now=now|default(datetime.datetime.now()) %}
    {% include 'components/footer.html' %}
    {% endwith %}
    
    <script>
        // Script pour montrer l'état de chargement sur le bouton
        document.getElementById('scraper-form').addEventListener('submit', function() {
            const button = document.getElementById('run-scraper-btn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SCRAPING EN COURS';
            button.classList.add('btn-loading');
        });

        // Variables globales pour le suivi
        let scrapingInProgress = false;
        let statusCheckInterval = null;
        let logCheckInterval = null;
        let lastLogId = 0;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // Fonction pour vérifier l'état du scraping
        function checkScrapingStatus() {
            fetch('{{ url_for("users.admin_scraper_status") }}')
                .then(response => response.json())
                .then(data => {
                    // Reset retry counter on successful response
                    retryCount = 0;
                    
                    if (data.status === 'running') {
                        // Scraping en cours
                        scrapingInProgress = true;
                        
                        // Afficher la barre de progression
                        document.getElementById('progress-container').style.display = 'block';
                        document.getElementById('run-scraper-btn').disabled = true;
                        
                        // Mettre à jour la barre de progression
                        const percent = data.progress && data.progress.percent || 0;
                        const progressBar = document.getElementById('progress-bar');
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                        
                        // Mettre à jour le statut
                        if (data.progress) {
                            document.getElementById('scraping-status').innerHTML = 
                                `Traitement en cours: ${data.progress.current || 0}/${data.progress.total || 0} URLs <br>` +
                                `Nouveaux: ${data.progress.new_added || 0} | Mis à jour: ${data.progress.updated || 0} | ` +
                                `Inchangés: ${data.progress.unchanged || 0} | Erreurs: ${data.progress.errors || 0}`;
                        }
                        
                        // S'assurer que l'intervalle de vérification des logs est actif
                        if (!logCheckInterval) {
                            logCheckInterval = setInterval(fetchLatestLogs, 2000);
                        }
                    } 
                    else if (data.status === 'completed') {
                        // Scraping terminé
                        scrapingInProgress = false;
                        clearInterval(statusCheckInterval);
                        
                        // Mettre à jour la barre de progression à 100%
                        const progressBar = document.getElementById('progress-bar');
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        document.getElementById('scraping-status').textContent = 'Scraping terminé avec succès!';
                        
                        // Récupérer les logs finaux
                        fetchLatestLogs();
                        
                        // Arrêter la vérification des logs après une dernière récupération
                        if (logCheckInterval) {
                            clearInterval(logCheckInterval);
                            logCheckInterval = null;
                        }
                        
                        // Rechargement de la page après 2 secondes
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                    else {
                        // Aucun scraping en cours
                        scrapingInProgress = false;
                        document.getElementById('progress-container').style.display = 'none';
                        document.getElementById('run-scraper-btn').disabled = false;
                        
                        // Arrêter la vérification des logs si aucun scraping en cours
                        if (logCheckInterval) {
                            clearInterval(logCheckInterval);
                            logCheckInterval = null;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la vérification du statut:', error);
                    retryCount++;
                    
                    // Si on a atteint le nombre maximum de tentatives, arrêter la vérification
                    if (retryCount > MAX_RETRIES) {
                        console.error(`Échec de la connexion après ${MAX_RETRIES} tentatives. Arrêt de la vérification.`);
                        clearInterval(statusCheckInterval);
                        
                        // Réinitialiser l'interface
                        document.getElementById('run-scraper-btn').disabled = false;
                        document.getElementById('run-scraper-btn').innerHTML = '<i class="fas fa-sync-alt"></i> LANCER LE SCRAPING';
                        
                        // Afficher un message d'erreur
                        const logContent = document.getElementById('log-content');
                        const logLine = document.createElement('div');
                        logLine.className = 'log-line log-error';
                        logLine.textContent = `[${new Date().toISOString()}] Erreur de communication avec le serveur. Le processus de scraping peut avoir échoué.`;
                        logContent.appendChild(logLine);
                        
                        // Afficher la console de logs si elle n'est pas déjà visible
                        document.getElementById('log-console').style.display = 'block';
                        document.getElementById('toggle-console-btn').innerHTML = '<i class="fas fa-terminal"></i> Masquer la console de logs';
                    }
                });
        }
        
        // Fonction pour récupérer les derniers logs
        function fetchLatestLogs() {
            fetch(`{{ url_for("users.admin_scraper_logs") }}?since=${lastLogId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        // Mettre à jour lastLogId avec l'ID du dernier log reçu
                        lastLogId = data.logs[data.logs.length - 1].id;
                        
                        // Ajouter les nouveaux logs à la console
                        const logContent = document.getElementById('log-content');
                        
                        data.logs.forEach(log => {
                            const logLine = document.createElement('div');
                            logLine.className = `log-line log-${log.level}`;
                            logLine.textContent = `[${log.timestamp}] ${log.message}`;
                            logContent.appendChild(logLine);
                        });
                        
                        // Auto-scroll si activé
                        const autoScrollEnabled = document.getElementById('autoscroll-btn').getAttribute('data-enabled') === 'true';
                        const logConsole = document.getElementById('log-console');
                        if (autoScrollEnabled) {
                            logConsole.scrollTop = logConsole.scrollHeight;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des logs:', error);
                });
        }
        
        // Vérifier l'état initial au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier immédiatement l'état du scraping
            checkScrapingStatus();
            
            // Configurer la vérification périodique
            statusCheckInterval = setInterval(checkScrapingStatus, 3000); // Vérifier toutes les 3 secondes
            
            // Gestion du bouton de la console
            const toggleConsoleBtn = document.getElementById('toggle-console-btn');
            const logConsole = document.getElementById('log-console');
            
            toggleConsoleBtn.addEventListener('click', function() {
                if (logConsole.style.display === 'block') {
                    logConsole.style.display = 'none';
                    toggleConsoleBtn.innerHTML = '<i class="fas fa-terminal"></i> Afficher la console de logs';
                } else {
                    logConsole.style.display = 'block';
                    toggleConsoleBtn.innerHTML = '<i class="fas fa-terminal"></i> Masquer la console de logs';
                    // Charger les logs immédiatement
                    fetchLatestLogs();
                }
            });
            
            // Gestion du bouton d'effacement des logs
            document.getElementById('clear-logs-btn').addEventListener('click', function() {
                document.getElementById('log-content').innerHTML = '';
            });
            
            // Gestion du bouton d'auto-scroll
            const autoscrollBtn = document.getElementById('autoscroll-btn');
            autoscrollBtn.addEventListener('click', function() {
                const currentState = autoscrollBtn.getAttribute('data-enabled') === 'true';
                const newState = !currentState;
                autoscrollBtn.setAttribute('data-enabled', newState.toString());
                autoscrollBtn.textContent = `Auto-scroll: ${newState ? 'ON' : 'OFF'}`;
            });
        });
        
        // Configurer le formulaire pour démarrer le scraping
        document.getElementById('scraper-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (!confirm('Voulez-vous lancer un scraping complet? Cette opération peut prendre plusieurs minutes.')) {
                return;
            }
            
            // Désactiver le bouton et montrer l'état de chargement
            const button = document.getElementById('run-scraper-btn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> DÉMARRAGE DU SCRAPING...';
            
            // Afficher la console de logs automatiquement
            document.getElementById('log-console').style.display = 'block';
            document.getElementById('toggle-console-btn').innerHTML = '<i class="fas fa-terminal"></i> Masquer la console de logs';
            
            // Ajouter un message dans la console pour indiquer le démarrage
            const logContent = document.getElementById('log-content');
            const logLine = document.createElement('div');
            logLine.className = 'log-line log-info';
            logLine.textContent = `[${new Date().toISOString()}] Démarrage du scraping...`;
            logContent.appendChild(logLine);
            
            // Envoyer la requête pour démarrer le scraping
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    // Montrer la barre de progression
                    document.getElementById('progress-container').style.display = 'block';
                    
                    // Démarrer la vérification périodique
                    scrapingInProgress = true;
                    retryCount = 0; // Réinitialiser le compteur de tentatives
                    if (!statusCheckInterval) {
                        statusCheckInterval = setInterval(checkScrapingStatus, 3000);
                    }
                } else {
                    // Erreur
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-sync-alt"></i> LANCER LE SCRAPING';
                    
                    // Ajouter un message d'erreur dans la console
                    const errorLine = document.createElement('div');
                    errorLine.className = 'log-line log-error';
                    errorLine.textContent = `[${new Date().toISOString()}] Erreur: ${data.message || "Une erreur est survenue"}`;
                    logContent.appendChild(errorLine);
                    
                    if (data.details) {
                        const detailsLine = document.createElement('div');
                        detailsLine.className = 'log-line log-error';
                        detailsLine.textContent = data.details;
                        logContent.appendChild(detailsLine);
                    }
                    
                    alert('Erreur: ' + data.message);
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-sync-alt"></i> LANCER LE SCRAPING';
                
                // Ajouter un message d'erreur dans la console
                const errorLine = document.createElement('div');
                errorLine.className = 'log-line log-error';
                errorLine.textContent = `[${new Date().toISOString()}] Erreur de communication: ${error.message}`;
                logContent.appendChild(errorLine);
                
                console.error('Erreur:', error);
            });
        });
        
        // Configurer le bouton d'arrêt
        document.getElementById('stop-scraper-btn').addEventListener('click', function() {
            if (!confirm('Voulez-vous vraiment arrêter le processus de scraping?')) {
                return;
            }
            
            fetch('{{ url_for("users.admin_stop_scraper") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'stopped') {
                    document.getElementById('scraping-status').textContent = 'Arrêt du scraping en cours...';
                    // Laisser le statut se mettre à jour naturellement
                } else {
                    alert('Erreur: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    </script>
</body>
</html>
