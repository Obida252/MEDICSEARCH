<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDICSEARCH • Recherche</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .medicine-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .medicine-tag {
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
        }
        .tag-icon {
            margin-right: 4px;
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    {% with active_page='search' %}
    {% include 'components/header.html' %}
    {% endwith %}

    <main>
        <section class="search-banner">
            <div class="container">
                <h2>RECHERCHE DE MÉDICAMENTS</h2>
                <p>Trouvez des informations complètes sur les médicaments disponibles dans notre base de données</p>
            </div>
        </section>
        
        <section class="search-section">
            <div class="container">
                <form class="search-form" method="GET" action="/search">
                    <div class="search-input-container">
                        <input type="text" name="search" placeholder="Nom du médicament ou ingrédient actif..." value="{{ search }}">
                        <button type="submit">RECHERCHER</button>
                    </div>
                    
                    <div class="advanced-search-toggle">
                        <input type="checkbox" id="show-filters" class="toggle-checkbox" {% if advanced_search %}checked{% endif %} onclick="toggleFilters()">
                        <label for="show-filters" class="toggle-label">RECHERCHE AVANCÉE</label>
                    </div>
                    
                    <div id="advanced-filters" class="advanced-filters {% if not advanced_search %}hidden{% endif %}">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label for="substance">SUBSTANCE ACTIVE</label>
                                <select name="substance" id="substance">
                                    <option value="">Toutes les substances</option>
                                    {% for substance_name in available_filters.substances %}
                                        <option value="{{ substance_name }}" {% if substance == substance_name %}selected{% endif %}>{{ substance_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="forme">FORME PHARMACEUTIQUE</label>
                                <select name="forme" id="forme">
                                    <option value="">Toutes les formes</option>
                                    {% for forme_name in available_filters.formes %}
                                        <option value="{{ forme_name }}" {% if forme == forme_name %}selected{% endif %}>{{ forme_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="filters-row">
                            <div class="filter-group">
                                <label for="laboratoire">LABORATOIRE</label>
                                <select name="laboratoire" id="laboratoire">
                                    <option value="">Tous les laboratoires</option>
                                    {% for lab_name in available_filters.laboratoires %}
                                        <option value="{{ lab_name }}" {% if laboratoire == lab_name %}selected{% endif %}>{{ lab_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="dosage">DOSAGE</label>
                                <select name="dosage" id="dosage">
                                    <option value="">Tous les dosages</option>
                                    {% for dosage_value in available_filters.dosages %}
                                        <option value="{{ dosage_value }}" {% if dosage == dosage_value %}selected{% endif %}>{{ dosage_value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <button type="submit" class="filter-btn">APPLIQUER LES FILTRES</button>
                            <a href="/search" class="reset-filter">RÉINITIALISER</a>
                        </div>
                    </div>
                    
                    {% if search %}
                        <a href="/search" class="reset-btn">RÉINITIALISER LA RECHERCHE</a>
                    {% endif %}
                    
                    <!-- Ajout d'un champ caché pour conserver la pagination lors du tri -->
                    <input type="hidden" name="page" value="{{ current_page }}">
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                </form>
            </div>
        </section>
        
        <section class="results-section">
            <div class="container">
                <div class="results-container">
                    <h2>RÉSULTATS DE RECHERCHE</h2>
                    
                    <!-- Stat card - sera mise à jour dynamiquement -->
                    <div class="stat-card" id="stat-card">
                        <span class="stat-number" id="result-count">0</span>
                        <span class="stat-label">MÉDICAMENT(S) TROUVÉ(S)</span>
                        <span class="stat-page" id="page-info">Chargement...</span>
                    </div>
                    
                    <!-- Contrôles de tri et nombre de résultats par page -->
                    <div class="results-controls">
                        <form id="results-controls-form" method="GET" action="/search">
                            <!-- Champs cachés pour conserver les filtres actuels -->
                            <input type="hidden" name="search" value="{{ search }}">
                            <input type="hidden" name="substance" value="{{ substance }}">
                            <input type="hidden" name="forme" value="{{ forme }}">
                            <input type="hidden" name="laboratoire" value="{{ laboratoire }}">
                            <input type="hidden" name="dosage" value="{{ dosage }}">
                            
                            <div class="controls-wrapper">
                                <div class="control-group">
                                    <label for="sort">TRIER PAR</label>
                                    <select name="sort" id="sort" onchange="document.getElementById('results-controls-form').submit()">
                                        {% if search %}
                                        <option value="relevance" {% if sort == 'relevance' %}selected{% endif %}>Pertinence</option>
                                        {% else %}
                                        <option value="relevance" disabled>Pertinence (recherche requise)</option>
                                        {% endif %}
                                        <option value="date_desc" {% if sort == 'date_desc' or (not search and sort == 'relevance') %}selected{% endif %}>Date (récent)</option>
                                        <option value="date_asc" {% if sort == 'date_asc' %}selected{% endif %}>Date (ancien)</option>
                                        <option value="name_asc" {% if sort == 'name_asc' %}selected{% endif %}>Nom (A-Z)</option>
                                        <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>Nom (Z-A)</option>
                                    </select>
                                </div>
                                
                                <div class="control-group">
                                    <label for="per_page">RÉSULTATS PAR PAGE</label>
                                    <select name="per_page" id="per_page" onchange="document.getElementById('results-controls-form').submit()">
                                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                                        <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
                                        <option value="1000" {% if per_page == 1000 %}selected{% endif %}>1000</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="loading-container">
                        <div class="loading-spinner" id="loading-spinner">
                            <div class="spinner"></div>
                            <p>Chargement des résultats...</p>
                        </div>
                    </div>
                    
                    <!-- Liste vide qui sera remplie dynamiquement -->
                    <ul class="medicine-list" id="medicine-list" style="opacity: 0;"></ul>
                    
                    <!-- Pagination qui sera générée dynamiquement -->
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </section>
    </main>

    {% with now=now|default({"year": 2023}) %}
    {% include 'components/footer.html' %}
    {% endwith %}

    <script>
        function toggleFilters() {
            const filtersContainer = document.getElementById('advanced-filters');
            if (filtersContainer.classList.contains('hidden')) {
                filtersContainer.classList.remove('hidden');
                filtersContainer.classList.add('visible');
            } else {
                filtersContainer.classList.remove('visible');
                filtersContainer.classList.add('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('input[name="search"]');
            const sortSelect = document.getElementById('sort');
            
            // Désactiver l'option de pertinence si pas de recherche
            searchInput.addEventListener('input', function() {
                const hasSearchTerm = this.value.trim().length > 0;
                const relevanceOption = sortSelect.querySelector('option[value="relevance"]');
                
                if (hasSearchTerm) {
                    relevanceOption.disabled = false;
                    relevanceOption.textContent = "Pertinence";
                } else {
                    relevanceOption.disabled = true;
                    relevanceOption.textContent = "Pertinence (recherche requise)";
                    
                    if (sortSelect.value === 'relevance') {
                        sortSelect.value = 'date_desc';
                    }
                }
            });
            
            // Charger les résultats dynamiquement
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search') || '';
            const page = parseInt(urlParams.get('page') || 1);
            const perPage = parseInt(urlParams.get('per_page') || 10);
            const substance = urlParams.get('substance') || '';
            const forme = urlParams.get('forme') || '';
            const laboratoire = urlParams.get('laboratoire') || '';
            const dosage = urlParams.get('dosage') || '';
            const sort = urlParams.get('sort') || 'date_desc';

            loadResults(searchQuery, page, perPage, substance, forme, laboratoire, dosage, sort);
        });

        async function loadResults(searchQuery, page, perPage, substance, forme, laboratoire, dosage, sort) {
            const medicineList = document.getElementById('medicine-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            const pagination = document.getElementById('pagination');
            const resultCount = document.getElementById('result-count');
            const pageInfo = document.getElementById('page-info');

            loadingSpinner.style.display = 'flex';
            medicineList.innerHTML = ''; // Nettoyer la liste existante
            medicineList.style.opacity = '0';

            try {
                // Construction de l'URL de l'API
                const apiUrl = `/api/search-results-stream?search=${encodeURIComponent(searchQuery)}&page=${page}&per_page=${perPage}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}`;

                // Utilisation de EventSource pour le streaming des résultats
                const eventSource = new EventSource(apiUrl);

                let resultsReceived = 0; // Compteur de résultats reçus
                let totalResults = 0;

                eventSource.onmessage = (event) => {
                    if (event.data === 'end') {
                        // Fin du flux, masquer le spinner et générer la pagination
                        loadingSpinner.style.opacity = '0';
                        setTimeout(() => {
                            loadingSpinner.style.display = 'none';
                            medicineList.style.opacity = '1';
                        }, 300);
                        
                        // Mettre à jour le nombre total de résultats
                        resultCount.textContent = totalResults;
                        pageInfo.textContent = `Page ${page} sur ${Math.ceil(totalResults / perPage)}`;

                        // Générer la pagination
                        generatePagination(pagination, Math.ceil(totalResults / perPage), page, searchQuery, substance, forme, laboratoire, dosage, sort, perPage);

                        eventSource.close();
                        
                        // Afficher le message "aucun résultat" si nécessaire
                        if (totalResults === 0) {
                            medicineList.innerHTML = `
                                <div class="no-results">
                                    <div class="no-results-icon"><i class="fas fa-search"></i></div>
                                    <h3 class="no-results-title">AUCUN MÉDICAMENT TROUVÉ</h3>
                                    <p class="no-results-message">Essayez d'autres termes de recherche ou vérifiez l'orthographe.</p>
                                </div>
                            `;
                        }
                        
                        return;
                    }

                    try {
                        const medicine = JSON.parse(event.data);
                        resultsReceived++;

                        // Créer un élément de liste pour le médicament
                        const li = document.createElement('li');
                        li.className = 'medicine-item';
                        li.dataset.index = resultsReceived - 1;
                        li.style.opacity = '0';
                        li.style.transform = 'translateY(20px)';

                        // Construction du HTML pour chaque médicament
                        let html = `
                            <a href="/medicine/${medicine.id}" class="medicine-link">
                                <div class="medicine-info">
                                    <h3 class="medicine-title">${medicine.title}</h3>
                                    <div class="medicine-meta">
                                        <span class="medicine-date"><i class="fas fa-calendar-alt medicine-icon"></i> Mise à jour: ${medicine.update_date || 'Non disponible'}</span>
                                    </div>
                        `;
                        
                        // Ajouter les correspondances de recherche si disponibles
                        if (searchQuery && medicine.search_matches) {
                            html += `
                                <div class="search-matches">
                                    <div class="search-matches-title">
                                        <i class="fas fa-search-location"></i> 
                                        ${medicine.match_count > 1 ? 
                                            `${medicine.match_count} occurrences trouvées dans:` : 
                                            'Terme trouvé dans:'}
                                    </div>
                                    <ul class="matches-list">
                            `;
                            
                            medicine.search_matches.forEach(match => {
                                let highlightedText = match.text;
                                if (match.term && match.text.toLowerCase().includes(match.term.toLowerCase())) {
                                    const regex = new RegExp(match.term, 'gi');
                                    highlightedText = match.text.replace(regex, '<span class="highlight-term">$&</span>');
                                }
                                
                                html += `
                                    <li class="match-item">
                                        <span class="match-location">${match.location}</span>
                                        <span class="match-excerpt">${highlightedText}</span>
                                    </li>
                                `;
                            });
                            
                            html += `
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Ajouter les tags si disponibles
                        if (medicine.medicine_details) {
                            html += '<div class="medicine-tags">';
                            
                            if (medicine.medicine_details.forme) {
                                html += `<span class="medicine-tag"><i class="fas fa-prescription-bottle tag-icon"></i> ${medicine.medicine_details.forme}</span>`;
                            }
                            
                            if (medicine.medicine_details.laboratoire) {
                                html += `<span class="medicine-tag"><i class="fas fa-flask tag-icon"></i> ${medicine.medicine_details.laboratoire}</span>`;
                            }
                            
                            if (medicine.medicine_details.dosages && medicine.medicine_details.dosages.length > 0) {
                                html += `<span class="medicine-tag"><i class="fas fa-balance-scale tag-icon"></i> ${medicine.medicine_details.dosages.join(', ')}</span>`;
                            }
                            
                            if (medicine.medicine_details.substances_actives && medicine.medicine_details.substances_actives.length > 0) {
                                html += `<span class="medicine-tag"><i class="fas fa-vial tag-icon"></i> ${medicine.medicine_details.substances_actives.join(', ')}</span>`;
                            }
                            
                            html += '</div>';
                        }
                        
                        html += `
                                </div>
                                <span class="arrow-icon">&rarr;</span>
                            </a>
                        `;

                        li.innerHTML = html;
                        medicineList.appendChild(li);

                        // Animation avec délai progressif
                        li.style.opacity = '1';
                        li.style.transform = 'translateY(0)';
                    } catch (e) {
                        console.error("Erreur lors du traitement du résultat:", e);
                    }
                };
                
                eventSource.addEventListener('count', (event) => {
                    const data = JSON.parse(event.data);
                    resultCount.textContent = data.count;
                });
                
                eventSource.addEventListener('total', (event) => {
                    const data = JSON.parse(event.data);
                    totalResults = data.total;
                });

                eventSource.onerror = (error) => {
                    console.error("Erreur EventSource:", error);
                    loadingSpinner.style.display = 'none';
                    medicineList.innerHTML = '<div class="error-message">Une erreur est survenue lors du chargement des résultats. Veuillez réessayer.</div>';
                    medicineList.style.opacity = '1';
                    eventSource.close();
                };
            } catch (error) {
                console.error("Erreur:", error);
                loadingSpinner.style.display = 'none';
                medicineList.innerHTML = '<div class="error-message">Une erreur est survenue lors du chargement des résultats. Veuillez réessayer.</div>';
                medicineList.style.opacity = '1';
            }
        }

        function generatePagination(paginationElement, totalPages, currentPage, search, substance, forme, laboratoire, dosage, sort, perPage) {
            if (!totalPages || totalPages <= 0) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Bouton précédent
            if (currentPage > 1) {
                html += `<a href="/search?search=${encodeURIComponent(search)}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}&page=${currentPage-1}&per_page=${perPage}" class="pagination-link prev-page">
                    <i class="fas fa-chevron-left"></i> Précédent
                </a>`;
            } else {
                html += `<span class="pagination-link disabled">
                    <i class="fas fa-chevron-left"></i> Précédent
                </span>`;
            }
            
            // Pages numérotées
            html += '<div class="page-numbers">';
            
            let startPage = Math.max(currentPage - 2, 1);
            let endPage = Math.min(startPage + 4, totalPages + 1);
            startPage = Math.max(endPage - 5, 1);
            
            if (startPage > 1) {
                html += `<a href="/search?search=${encodeURIComponent(search)}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}&page=1&per_page=${perPage}" class="pagination-link">1</a>`;
                if (startPage > 2) {
                    html += '<span class="pagination-ellipsis">...</span>';
                }
            }
            
            for (let p = startPage; p < endPage; p++) {
                if (p === currentPage) {
                    html += `<span class="pagination-link active">${p}</span>`;
                } else {
                    html += `<a href="/search?search=${encodeURIComponent(search)}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}&page=${p}&per_page=${perPage}" class="pagination-link">${p}</a>`;
                }
            }
            
            if (endPage <= totalPages) {
                if (endPage < totalPages) {
                    html += '<span class="pagination-ellipsis">...</span>';
                }
                html += `<a href="/search?search=${encodeURIComponent(search)}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}&page=${totalPages}&per_page=${perPage}" class="pagination-link">${totalPages}</a>`;
            }
            
            html += '</div>';
            
            // Bouton suivant
            if (currentPage < totalPages) {
                html += `<a href="/search?search=${encodeURIComponent(search)}&substance=${encodeURIComponent(substance)}&forme=${encodeURIComponent(forme)}&laboratoire=${encodeURIComponent(laboratoire)}&dosage=${encodeURIComponent(dosage)}&sort=${sort}&page=${currentPage+1}&per_page=${perPage}" class="pagination-link next-page">
                    Suivant <i class="fas fa-chevron-right"></i>
                </a>`;
            } else {
                html += `<span class="pagination-link disabled">
                    Suivant <i class="fas fa-chevron-right"></i>
                </span>`;
            }
            
            paginationElement.innerHTML = html;
        }
    </script>
    
    <style>
        .stat-note {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }
        .error-message {
            padding: 20px;
            background-color: #fff0f0;
            border-left: 4px solid #ff5252;
            margin: 20px 0;
            color: #800000;
            text-align: center;
        }
    </style>
</body>
</html>